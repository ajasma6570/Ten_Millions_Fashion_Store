<%-include('../partial/header')-%>
  

        <main class="main">
        	<div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
        		<div class="container">
        			<h1 class="page-title">Shopping Cart<span>Shop</span></h1>
        		</div><!-- End .container -->
        	</div><!-- End .page-header -->
            <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <div class="container">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="/shirts">Shop</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Shopping Cart</li>
                    </ol>
                </div><!-- End .container -->
            </nav><!-- End .breadcrumb-nav -->

            <div class="page-content">
            	<div class="cart">
	                <div class="container">
						<% if(cart  && cart.products.length) {%>
	                	<div class="row">
	                		<div class="col-lg-9">
	                			<table  id="myTable" class="table table-cart table-mobile">
									
									<thead>
										<tr>
											<th>Product</th>
											<th>Price</th>
											<th>Offer price</th>
											<th>Quantity</th>
											<th>Total</th>
											<th></th>
										</tr>
									</thead>

									<tbody>
										<% cart.products.reverse().forEach((product)=>{ %>
										<tr>
											<td class="product-col">
												<div class="product">
													<figure class="product-media">
														<a href="#">
															<img src="upload/<%=product.productid.productimage[0]%>" alt="Product image">
														</a>
													</figure>

													<h3 class="product-title">
														<a href="#"><%=product.productid.productname%></a>
													</h3><!-- End .product-title -->
												</div><!-- End .product -->
											</td>
											<input type="hidden" id="cartid" value="<%=cart._id%>">
											<td class="price-col">
												₹<%=product.productid.price%>.00
											</td>

											<td class="price-col price">
												<%if(product.productid.offerpercentage || product.productid.categorypercentage ){%>

													<% if(product.productid.categorypercentage > product.productid.offerpercentage){ %>
														<span class="categorypercentage" data-categorypercentage="<%= product.productid.categorypercentage %>" >
														₹<%=product.productid.categoryprice%>.00

														<% }else{ %>
															<span class="offerpercentage" data-offerpercentage="<%= product.productid.offerpercentage %>" >
															₹<%=product.productid.offerprice%>.00

															<% } %>

													<% }else{ %>

														₹<%=product.productid.price%>.00

														<% } %>
													
												
											</td>
											
											<td class="quantity-col">
												
												<button class="cart-qty-minus" style="border: none;" data-proid="<%=product.productid._id%>" type="button" >-</button>
												<input type="text"  name="qty" min="0" class="qty text-center" min="0"  value="<%=product.Cartquantity%>" style="width: 30px;" readonly>
												<button class="cart-qty-plus" style="border: none;" data-proid="<%=product.productid._id%>"  type="button" >+</button>
                                           
											</td>
											<td class="total-col amount"></td>
											<td class="remove-col"><a href="/deleteCartItem?id=<%=product.id %>" class="btn-remove"><i class="icon-close"></i></a></td>
											
										</tr>
										<% }) %>
									</tbody>
								</table><!-- End .table table-wishlist -->

	                			<div class="cart-bottom ">
			            			<!-- <div class="cart-discount">
			            				<form action="#">
			            					<div class="input-group">
				        						<input type="text" class="form-control" required placeholder="coupon code">
				        						<div class="input-group-append">
													<button class="btn btn-outline-primary-2" type="submit"><i class="icon-long-arrow-right"></i></button>
												</div>
			        						</div>
			            				</form>
			            			</div> -->

			            			<a href="/cart" class="btn btn-outline-dark-2 "><span >UPDATE CART</span><i class="icon-refresh"></i></a>
		            			</div><!-- End .cart-bottom -->
	                		</div><!-- End .col-lg-9 -->
	                		<aside class="col-lg-3">
	                			<div class="summary summary-cart">
	                				<h3 class="summary-title">Cart Total</h3><!-- End .summary-title -->

	                				<table class="table table-summary">
	                					<tbody>
	                						<tr class="summary-subtotal">
	                							<td>Subtotal:</td>
	                							<td class="total"></td>
	                						</tr><!-- End .summary-subtotal -->
	                						<tr class="summary-shipping">
	                							<td>Shipping:</td>
	                							<td>Free shipping</td>
	                						</tr>

	                						

	                						<tr class="summary-shipping-estimate">
	                							<td>Estimate for Your Country<br> <a href="dashboard.html">Change address</a></td>
	                							<td>&nbsp;</td>
	                						</tr><!-- End .summary-shipping-estimate -->

	                						<tr class="summary-total">
	                							<td>Total:</td>
	                							<td class="total"></td>
	                						</tr><!-- End .summary-total -->
	                					</tbody>
										
	                				</table><!-- End .table table-summary -->

	                				<a href="/checkout" class="btn btn-outline-primary-2 btn-order btn-block">PROCEED TO CHECKOUT</a>
	                			</div><!-- End .summary -->

		            			<a href="/" class="btn btn-outline-dark-2 btn-block mb-3"><span>CONTINUE SHOPPING</span><i class="icon-refresh"></i></a>
	                		</aside><!-- End .col-lg-3 -->
	                	</div><!-- End .row -->
						<% }else{ %>
							<div  class="text-center">
							<p> <strong>Hi <%=userdata.name%>,</strong> <br> Your Cart is Empty</p> <br>
							<div>
								<a href="/" class="btn btn-outline-dark-2  mb-3"><span>CONTINUE SHOPPING</span><i class="icon-refresh"></i></a>

							</div>
						</div>
							<% } %>
	                </div><!-- End .container -->
                </div><!-- End .cart -->
            </div><!-- End .page-content -->
        </main><!-- End .main -->



		<script src="https://code.jquery.com/jquery-3.6.4.slim.js" integrity="sha256-dWvV84T6BhzO4vG6gWhsWVKVoa4lVmLnpBOZh/CAHU4=" crossorigin="anonymous"></script>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.css">
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.js"></script>
		


		<script>
          
$(document).ready(function(){
  update_amounts();
  
  // Handle quantity changes
  $('.qty,.price').on('keyup keypress blur change', function(e){
    update_amounts();
  });
  
  // Handle increment/decrement buttons
  $('.cart-qty-plus').on('click', function(){
	console.log("clicked");
	var proID = $(this).data('proid')
     var input = $(this).siblings('.qty');
	var qty = $(this).siblings('.qty').val();
	var data = {quantity:qty,proID:proID}
  	
	//with incrementing the quatity number ajax call
	$.ajax({
		url:'/incrementproduct',
		method:"post",
		data:data,
		success: function(response){
		console.log(response.message);
		 if(response.message == "0"){
		// if response is zero it means product Quantity is unavailable
			console.log("failed");
			Swal.fire({
                            title: "Error",
                            text: "Item is Out of Stoke",
                            icon: "error",
                            confirmButtonText: "OK"
                        }); 
		 }else{
			
          var val = parseInt(input.val());
          input.val(val + 1);
          update_amounts();
		 }
		}
	})

  });

 		 $(".cart-qty-minus").on("click", function () {
                console.log("clicked");
                var proID = $(this).data("proid");
                var input = $(this).siblings(".qty");
				var qty = $(this).siblings('.qty').val();
                var data = {quantity:qty,proID:proID}
				
                $.ajax({
                url: '/decrement',                    
                method: "post",
				data:data,
                success: function (response) {
                    if (response.message == "0"){
                    Swal.fire({
                        title: "Error",
                        html: "Product quantity cannot be less than 1,<br> You can delete product.",
                        icon: "error",
                        confirmButtonText: "OK",
                    });
                    } else {
                    var val = parseInt(input.val());
                    input.val(val - 1);
                    update_amounts();
                    }
                },
                });

				});

			});

function update_amounts(){
  var sum = 0.0;
  $('#myTable > tbody > tr').each(function(){
	var catoffer = $(this).find('.categorypercentage');
	var offoffer = $(this).find('.offerpercentage');

	var categoryPercentage =catoffer.length > 0 ? catoffer.data('categorypercentage') : null;
    var offerPercentage = offoffer.length > 0 ? offoffer.data('offerpercentage') : null;

	console.log("cat ***"+categoryPercentage);
	console.log("off **"+offerPercentage);
	console.log(categoryPercentage>offerPercentage);

	var catoffer=$(this).find('.categorypercentage').text().replace(/[^\d\.]/g, '');
	var offer = $(this).find('.offerpercentage').text().replace(/[^\d\.]/g, '');
	console.log("cata ***"+catoffer);
	console.log("offa **"+offer);
	if(categoryPercentage>offerPercentage){
		
		var qty = $(this).find('.qty').val();
    var offer = $(this).find('.offerprice').text().replace(/[^\d\.]/g, '');
    var amount = qty * catoffer;
    sum += amount;
    $(this).find('.amount').text('₹' + amount.toFixed(2));
		
	}else{
		var qty = $(this).find('.qty').val();
    var price = $(this).find('.price').text().replace(/[^\d\.]/g, '');
    var amount = qty * price;
    sum += amount;
    $(this).find('.amount').text('₹' + amount.toFixed(2));
	}
    
  });
  $('.total').text('₹' + sum.toFixed(2));


}
        </script>

<%-include('../partial/footer')-%>